<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Primary SEO Meta Tags -->
    <title>Create Secret Link - OneTimeView | Secure Self-Destruct Message & File Sharing</title>
    <meta name="description"
        content="Create a secure one-time message or file link. Add password protection, set view limits (1-10), and choose expiry times. Free, secure, and takes seconds.">
    <meta name="keywords"
        content="create secret message, one time file sharing, burn after reading, secure message, password protected link, self destruct file, temporary link">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://onetimeview.com/create">

    <!-- Mobile & Theme -->
    <meta name="theme-color" content="#8B5CF6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://onetimeview.com/create">
    <meta property="og:title" content="Create Secret Link - OneTimeView">
    <meta property="og:description"
        content="Create secure self-destructing links for messages and files. Password protection, view limits, and automatic deletion.">
    <meta property="og:image" content="https://onetimeview.com/static/og-image.jpg">
    <meta property="og:site_name" content="OneTimeView">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://onetimeview.com/create">
    <meta name="twitter:title" content="Create Secret Link - OneTimeView">
    <meta name="twitter:description"
        content="Create secure self-destructing links for messages and files. Password protection, view limits, and automatic deletion.">
    <meta name="twitter:image" content="https://onetimeview.com/static/og-image.jpg">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">

    <!-- Performance Optimization -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/tailwind-config.js"></script>
    <script src="/static/config.js"></script>
    <link rel="stylesheet" href="/static/styles.css">

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebPage",
      "name": "Create Secret Link",
      "description": "Create secure self-destructing links for confidential messages and files",
      "url": "https://onetimeview.com/create",
      "potentialAction": {
        "@type": "CreateAction",
        "name": "Create Secret",
        "target": "https://onetimeview.com/create"
      }
    }
    </script>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "https://onetimeview.com/"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Create Secret",
          "item": "https://onetimeview.com/create"
        }
      ]
    }
    </script>
</head>

<body class="bg-background min-h-screen text-text-primary">
    <!-- Navigation -->
    <nav class="border-b border-card-border">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <a href="/" class="flex items-center gap-2 group">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"
                        class="transition-transform group-hover:scale-110">
                        <path d="M16 8C10 8 5 12 3 16C5 20 10 24 16 24C22 24 27 20 29 16C27 12 22 8 16 8Z"
                            stroke="#6D5DF6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            fill="none" />
                        <circle cx="16" cy="16" r="5" fill="#6D5DF6" />
                        <text x="16" y="20" font-family="Arial, sans-serif" font-size="8" font-weight="bold"
                            fill="white" text-anchor="middle">1</text>
                        <circle cx="8" cy="6" r="1" fill="#6D5DF6" opacity="0.6" />
                        <circle cx="11" cy="4" r="0.8" fill="#6D5DF6" opacity="0.4" />
                        <circle cx="14" cy="3" r="0.6" fill="#6D5DF6" opacity="0.3" />
                        <circle cx="18" cy="3" r="0.6" fill="#6D5DF6" opacity="0.3" />
                        <circle cx="21" cy="4" r="0.8" fill="#6D5DF6" opacity="0.4" />
                        <circle cx="24" cy="6" r="1" fill="#6D5DF6" opacity="0.6" />
                    </svg>
                    <span
                        class="text-xl font-semibold text-primary group-hover:text-white transition-colors">OneTimeView</span>
                </a>
                <div class="flex gap-6 text-sm">
                    <a href="/" class="text-text-muted hover:text-white transition-colors">Home</a>
                    <a href="/privacy" class="text-text-muted hover:text-white transition-colors">Privacy</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-12">
        <div class="max-w-3xl mx-auto">
            <h1 class="text-3xl md:text-4xl font-bold mb-3 text-center text-white">Create Your Secret</h1>
            <p class="text-text-secondary text-center mb-8 text-sm">
                This content will be permanently deleted after viewing
            </p>

            <div id="successMessage"
                class="hidden bg-card border border-primary rounded-lg p-4 sm:p-6 mb-6 shadow-soft-lg">
                <h3 class="text-lg font-semibold mb-3 text-white">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="16 12 12 8 8 12"></polyline>
                    <line x1="12" y1="16" x2="12" y2="8"></line>
                    </svg>
                    <span>Secret Created Successfully!</span>
                </h3>
                <p class="text-gray-300 mb-4">Share this link with your recipient:</p>
                <div
                    class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-3 sm:space-y-0 sm:space-x-3">
                    <input type="text" id="secretLink" readonly
                        class="flex-1 bg-background border border-card-border rounded-lg px-4 py-3 text-white">
                    <button onclick="copyLink()"
                        class="w-full sm:w-auto bg-cta hover:bg-cta-hover text-white px-6 py-3 rounded-lg font-bold transition copy-btn whitespace-nowrap">
                        Copy Link
                    </button>
                </div>
                <p class="text-sm text-text-secondary mt-3" id="expiryInfo"></p>
                <div class="mt-4">
                    <a href="/create" class="text-primary-light hover:text-primary underline">Create another secret</a>
                </div>
            </div>

            <form id="secretForm" class="bg-card rounded-lg p-6 md:p-8 border border-card-border shadow-soft">
                <!-- Content Type Selection -->
                <div class="mb-6">
                    <label class="block text-lg font-bold mb-3">Content Type</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button type="button" onclick="selectType('text')"
                            class="type-btn bg-background hover:bg-card/50 border-2 border-transparent rounded-lg p-4 transition"
                            id="btn-text">
                            <div class="flex justify-center mb-2">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                    class="text-primary">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10 9 9 9 8 9"></polyline>
                                </svg>
                            </div>
                            <div class="font-bold">Text</div>
                        </button>
                        <button type="button" onclick="selectType('image')"
                            class="type-btn bg-background hover:bg-card/50 border-2 border-card-border rounded-lg p-4 transition"
                            id="btn-image">
                            <div class="flex justify-center mb-2">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                    class="text-primary">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                            </div>
                            <div class="font-bold">Image</div>
                        </button>
                        <button type="button" onclick="selectType('video')"
                            class="type-btn bg-background hover:bg-card/50 border-2 border-card-border rounded-lg p-4 transition"
                            id="btn-video">
                            <div class="flex justify-center mb-2">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                    class="text-primary">
                                    <polygon points="23 7 16 12 23 17 23 7"></polygon>
                                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                                </svg>
                            </div>
                            <div class="font-bold">Video</div>
                        </button>
                        <button type="button" onclick="selectType('file')"
                            class="type-btn bg-background hover:bg-card/50 border-2 border-card-border rounded-lg p-4 transition"
                            id="btn-file">
                            <div class="flex justify-center mb-2">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                    class="text-primary">
                                    <path
                                        d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48">
                                    </path>
                                </svg>
                            </div>
                            <div class="font-bold">File</div>
                        </button>
                    </div>
                </div>

                <!-- Text Content -->
                <div id="textContent" class="mb-6">
                    <label class="block text-lg font-bold mb-3">Your Secret Message</label>
                    <textarea id="contentField" rows="8"
                        class="w-full bg-background border border-card-border rounded-lg px-4 py-3 text-white focus:border-primary focus:outline-none"
                        placeholder="Enter your confidential message here..."></textarea>
                    <p class="text-sm text-text-secondary mt-2">Maximum 50,000 characters</p>
                </div>

                <!-- File Upload -->
                <div id="fileContent" class="mb-6 hidden">
                    <label class="block text-lg font-bold mb-3">Upload File</label>
                    <div class="upload-area border-2 border-dashed border-primary rounded-lg p-8 text-center cursor-pointer"
                        id="uploadArea" ondrop="handleDrop(event)" ondragover="handleDragOver(event)"
                        ondragleave="handleDragLeave(event)" onclick="document.getElementById('fileInput').click()">
                        <div class="flex justify-center mb-3">
                            <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary">
                                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                                <polyline points="13 2 13 9 20 9"></polyline>
                            </svg>
                        </div>
                        <p class="text-lg font-bold mb-2">Drop file here or click to browse</p>
                        <p class="text-sm text-text-secondary">
                            Up to <span id="maxSize">100MB</span> &middot; best under 25MB for slow networks
                        </p>
                    </div>
                    <input type="file" id="fileInput" class="hidden" onchange="handleFileSelect(event)">
                    <div id="fileInfo" class="hidden mt-4 bg-background rounded-lg p-4">
                        <p class="font-bold" id="fileName"></p>
                        <p class="text-sm text-text-secondary" id="fileSize"></p>
                    </div>
                    <div id="uploadProgress" class="hidden mt-3">
                        <div class="bg-background rounded-full h-2 overflow-hidden">
                            <div id="progressBar"
                                class="progress-bar bg-gradient-to-r from-primary to-primary-hover h-full"
                                style="width: 0%"></div>
                        </div>
                        <p class="text-center text-xs sm:text-sm text-text-secondary mt-1" id="progressText">Uploading...</p>
                    </div>
                </div>

                <!-- Password Protection (Premium) -->
                <div class="mb-6">
                    <label class="block text-lg font-bold mb-3 flex items-center gap-2">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        <span>Password Protection</span>
                    </label>
                    <input type="password" id="passwordField"
                        class="w-full bg-background border border-card-border rounded-lg px-4 py-3 text-white focus:border-primary focus:outline-none"
                        placeholder="Optional password">
                    <p class="text-sm text-text-secondary mt-2">Recipient will need this password to view the secret</p>
                </div>

                <!-- View Limit -->
                <div class="mb-6">
                    <label class="block text-lg font-bold mb-3 flex items-center gap-2">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span>View Limit</span>
                    </label>
                    <p class="text-sm text-text-secondary mb-3">Choose how many times this secret can be opened.</p>
                    <select id="maxViewsField"
                        class="w-full bg-background border border-card-border rounded-lg px-4 py-3 text-white focus:border-primary focus:outline-none"
                        onchange="updateViewLimitHelperText()">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                    <p class="text-sm text-text-secondary mt-2">After the selected number of views, the secret will be
                        permanently deleted.</p>
                    <div id="viewLimitHelperText" class="mt-3 text-sm"></div>
                </div>

                <!-- Expiry Options -->
                <div class="mb-6">
                    <label class="block text-lg font-bold mb-3 flex items-center gap-2">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span>Expiration</span>
                    </label>
                    <select id="expiryField"
                        class="w-full bg-background border border-card-border rounded-lg px-4 py-3 text-white focus:border-primary focus:outline-none">
                        <option value="24">24 Hours</option>
                        <option value="720">30 Days</option>
                        <option value="4320">6 Months</option>
                        <option value="0" disabled>No Expiry (Premium)</option>
                    </select>
                    <p class="text-sm text-text-secondary mt-2">Content will also be deleted after reaching view
                        limit</p>
                </div>

                <!-- Premium Toggle (Hidden checkbox for demo) -->
                <input type="checkbox" id="isPremium" class="hidden">

                <!-- Submit Button -->
                <button type="submit"
                    class="w-full bg-cta hover:bg-cta-hover text-white font-bold py-4 px-6 rounded-lg text-lg transition transform hover:scale-105 flex items-center justify-center gap-2">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    Create Secret Link
                </button>

                <p class="text-center text-sm text-text-secondary mt-4">
                    By creating a secret, you agree to our <a href="/terms"
                        class="text-primary-light hover:underline">Terms of Service</a>
                </p>
            </form>
        </div>
    </div>

    <script>
        let selectedType = 'text';
        let selectedFile = null;
        const MAX_FILE_SIZE_MB = 100;

        // Initialize view limit helper text on page load
        document.addEventListener('DOMContentLoaded', function () {
            updateViewLimitHelperText();
        });

        function updateViewLimitHelperText() {
            const maxViews = parseInt(document.getElementById('maxViewsField').value);
            const helperDiv = document.getElementById('viewLimitHelperText');

            if (maxViews === 1) {
                helperDiv.innerHTML = `
                    <div class="flex items-start space-x-2 bg-primary/10 border border-primary/30 rounded-lg p-3">
                        <span class="text-primary-light">✓</span>
                        <span class="text-primary-light font-medium">This is a one-time view link.</span>
                    </div>
                `;
            } else {
                helperDiv.innerHTML = `
                    <div class="flex items-start space-x-2 bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
                        <span class="text-yellow-400">⚠</span>
                        <span class="text-yellow-400">Anyone with this link can open it until the view limit is reached.</span>
                    </div>
                `;
            }
        }

        function selectType(type) {
            selectedType = type;

            // Update button states
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('border-primary', 'bg-primary/20');
            });
            document.getElementById(`btn-${type}`).classList.add('border-primary', 'bg-primary/20');

            // Update file input accept attribute based on content type
            const fileInput = document.getElementById('fileInput');
            if (type === 'image') {
                fileInput.setAttribute('accept', 'image/*');
            } else if (type === 'video') {
                fileInput.setAttribute('accept', 'video/*');
            } else if (type === 'file') {
                fileInput.setAttribute('accept', '*/*');
            }

            // Show/hide content areas
            if (type === 'text') {
                document.getElementById('textContent').classList.remove('hidden');
                document.getElementById('fileContent').classList.add('hidden');
            } else {
                document.getElementById('textContent').classList.add('hidden');
                document.getElementById('fileContent').classList.remove('hidden');
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('uploadArea').classList.add('dragging');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('uploadArea').classList.remove('dragging');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('uploadArea').classList.remove('dragging');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        }

        function handleFile(file) {
            selectedFile = file;
            const sizeMb = file.size / 1024 / 1024;

            if (sizeMb > MAX_FILE_SIZE_MB) {
                selectedFile = null;
                document.getElementById('fileInfo').classList.add('hidden');
                document.getElementById('fileInput').value = '';
                alert(`This file is ${sizeMb.toFixed(2)} MB. The maximum allowed size is ${MAX_FILE_SIZE_MB} MB. Please choose a smaller file.`);
                return;
            }

            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = `${sizeMb.toFixed(2)} MB`;
        }

        async function getCloudinarySignature(resourceType) {
            const res = await fetch(API_BASE_URL + '/api/uploads/sign', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ resource_type: resourceType })
            });
            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.detail || 'Failed to prepare upload');
            }
            return res.json();
        }

        function uploadFileToCloudinary(file, contentType, onProgress) {
            const resourceType = contentType === 'video' ? 'video' : 'raw';
            return getCloudinarySignature(resourceType).then(sign => {
                const url = `https://api.cloudinary.com/v1_1/${sign.cloud_name}/${sign.resource_type}/upload`;
                const fd = new FormData();
                fd.append('file', file);
                fd.append('api_key', sign.api_key);
                fd.append('timestamp', sign.timestamp);
                fd.append('signature', sign.signature);
                fd.append('folder', sign.folder);

                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', url, true);

                    if (xhr.upload && onProgress) {
                        xhr.upload.onprogress = onProgress;
                    }

                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === XMLHttpRequest.DONE) {
                            if (xhr.status >= 200 && xhr.status < 300) {
                                try {
                                    const data = JSON.parse(xhr.responseText);
                                    resolve(data);
                                } catch (e) {
                                    reject(new Error('Upload response parse error'));
                                }
                            } else {
                                reject(new Error('Cloud storage upload failed'));
                            }
                        }
                    };

                    xhr.onerror = function () {
                        reject(new Error('Network error during file upload'));
                    };

                    xhr.send(fd);
                });
            });
        }

        // Fallback: upload file through our API (old behavior)
        function uploadFileViaBackend(file, contentType, onProgress) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('content_type', contentType);
                formData.append('file', file);

                const xhr = new XMLHttpRequest();
                xhr.open('POST', API_BASE_URL + '/api/secrets', true);

                if (xhr.upload && onProgress) {
                    xhr.upload.onprogress = onProgress;
                }

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            try {
                                const data = JSON.parse(xhr.responseText);
                                resolve({ backend_secret: data });
                            } catch (e) {
                                reject(new Error('Upload response parse error'));
                            }
                        } else {
                            reject(new Error('Backend upload failed'));
                        }
                    }
                };

                xhr.onerror = function () {
                    reject(new Error('Network error during file upload'));
                };

                xhr.send(formData);
            });
        }

        document.getElementById('secretForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitButton = document.querySelector('#secretForm button[type="submit"]');
            const uploadProgress = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            const isPremium = document.getElementById('isPremium').checked;
            const expiryHours = parseInt(document.getElementById('expiryField').value);
            const maxViews = parseInt(document.getElementById('maxViewsField').value);
            const password = document.getElementById('passwordField').value || null;

            try {
                submitButton.disabled = true;
                submitButton.classList.add('opacity-70', 'cursor-not-allowed');

                if (selectedType === 'text') {
                    const content = document.getElementById('contentField').value;
                    if (!content.trim()) {
                        alert('Please enter a message');
                        return;
                    }

                    const formData = new FormData();
                    formData.append('content_type', 'text');
                    formData.append('content', content);
                    formData.append('is_premium', isPremium);
                    formData.append('expiry_hours', expiryHours);
                    formData.append('max_views', maxViews);
                    if (password) {
                        formData.append('password', password);
                    }

                    const res = await fetch(API_BASE_URL + '/api/secrets', {
                        method: 'POST',
                        body: formData
                    });
                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        throw new Error(err.detail || 'Failed to create secret');
                    }
                    const data = await res.json();

                    document.getElementById('secretForm').classList.add('hidden');
                    document.getElementById('successMessage').classList.remove('hidden');
                    document.getElementById('secretLink').value = data.url;

                    if (data.expires_at) {
                        const expiryDate = new Date(data.expires_at);
                        const viewText = data.max_views === 1 ? 'first view' : `${data.max_views} views`;
                        document.getElementById('expiryInfo').textContent =
                            `⏰ Expires on ${expiryDate.toLocaleString()} or after ${viewText}`;
                    } else {
                        const viewText = data.max_views === 1 ? 'first view' : `${data.max_views} views`;
                        document.getElementById('expiryInfo').textContent =
                            `⚠️ Will be deleted after ${viewText}`;
                    }

                    document.getElementById('successMessage').scrollIntoView({ behavior: 'smooth' });
                    return;
                }

                // File / image / video flow: direct to Cloudinary, then create secret
                if (!selectedFile) {
                    alert('Please select a file');
                    return;
                }

                // Reset and show progress UI
                uploadProgress.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressText.textContent = 'Starting upload...';
                uploadProgress.scrollIntoView({ behavior: 'smooth', block: 'center' });

                let finalSecretData = null;

                try {
                    // Preferred path: direct to Cloudinary
                    const cloudinaryResponse = await uploadFileToCloudinary(
                        selectedFile,
                        selectedType,
                        function (event) {
                            if (event.lengthComputable && event.total > 0) {
                                const rawPercent = Math.round((event.loaded / event.total) * 100);
                                const percent = Math.min(rawPercent, 95);
                                progressBar.style.width = percent + '%';
                                progressText.textContent = `Uploading... ${percent}%`;
                            } else {
                                progressText.textContent = 'Uploading...';
                            }
                        }
                    );

                    // Small finalization step with your API
                    progressBar.style.width = '95%';
                    progressText.textContent = 'Finalizing...';

                    const payload = {
                        content_type: selectedType,
                        file_name: selectedFile.name,
                        mime_type: selectedFile.type,
                        cloud_url: cloudinaryResponse.secure_url,
                        cloud_public_id: cloudinaryResponse.public_id,
                        cloud_resource_type: cloudinaryResponse.resource_type,
                        password,
                        expiry_hours: expiryHours,
                        max_views: maxViews,
                        is_premium: isPremium
                    };

                    const res = await fetch(API_BASE_URL + '/api/secrets/from-cloudinary', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        throw new Error(err.detail || 'Failed to create secret');
                    }

                    finalSecretData = await res.json();
                } catch (cloudErr) {
                    // Fallback: try legacy backend upload if direct upload path fails (e.g. endpoint not deployed yet)
                    console.error('Direct cloud upload failed, falling back to backend upload:', cloudErr);
                    progressBar.style.width = '0%';
                    progressText.textContent = 'Network seems slow, trying via server...';

                    const backendResult = await uploadFileViaBackend(
                        selectedFile,
                        selectedType,
                        function (event) {
                            if (event.lengthComputable && event.total > 0) {
                                const rawPercent = Math.round((event.loaded / event.total) * 100);
                                const percent = Math.min(rawPercent, 95);
                                progressBar.style.width = percent + '%';
                                progressText.textContent = `Uploading... ${percent}%`;
                            } else {
                                progressText.textContent = 'Uploading...';
                            }
                        }
                    );

                    finalSecretData = backendResult.backend_secret;
                }

                progressBar.style.width = '100%';
                progressText.textContent = 'Done!';

                document.getElementById('secretForm').classList.add('hidden');
                document.getElementById('successMessage').classList.remove('hidden');
                document.getElementById('secretLink').value = finalSecretData.url;

                if (finalSecretData.expires_at) {
                    const expiryDate = new Date(finalSecretData.expires_at);
                    const viewText = finalSecretData.max_views === 1 ? 'first view' : `${finalSecretData.max_views} views`;
                    document.getElementById('expiryInfo').textContent =
                        `⏰ Expires on ${expiryDate.toLocaleString()} or after ${viewText}`;
                } else {
                    const viewText = finalSecretData.max_views === 1 ? 'first view' : `${finalSecretData.max_views} views`;
                    document.getElementById('expiryInfo').textContent =
                        `⚠️ Will be deleted after ${viewText}`;
                }

                document.getElementById('successMessage').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                let message = error.message || 'Upload failed. Please try again.';
                if (message.includes('Network')) {
                    message = 'Upload failed due to network issues. Please check your connection or try a smaller file.';
                } else if (message.toLowerCase().includes('failed')) {
                    message = 'Upload failed. Please try again with a smaller file or more stable connection.';
                }
                alert(message);
                uploadProgress.classList.add('hidden');
            } finally {
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        });

        function copyLink() {
            const linkInput = document.getElementById('secretLink');
            linkInput.select();
            document.execCommand('copy');

            // Show toast notification
            showToast('Link copied to clipboard!');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2';

            // Create SVG checkmark icon
            const svgIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svgIcon.setAttribute('width', '20');
            svgIcon.setAttribute('height', '20');
            svgIcon.setAttribute('viewBox', '0 0 24 24');
            svgIcon.setAttribute('fill', 'none');
            svgIcon.setAttribute('stroke', 'currentColor');
            svgIcon.setAttribute('stroke-width', '3');
            svgIcon.setAttribute('stroke-linecap', 'round');
            svgIcon.setAttribute('stroke-linejoin', 'round');
            svgIcon.style.flexShrink = '0';

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', 'M20 6L9 17L4 12');

            svgIcon.appendChild(path);

            toast.appendChild(svgIcon);
            toast.appendChild(document.createTextNode(message));
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Initialize
        selectType('text');

        // Check if redirected from homepage with success
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('success') === 'true' && urlParams.get('url')) {
            const secretUrl = decodeURIComponent(urlParams.get('url'));

            // Hide the form and show success message
            document.getElementById('secretForm').classList.add('hidden');
            document.getElementById('successMessage').classList.remove('hidden');
            document.getElementById('secretLink').value = secretUrl;

            // Set default expiry info for quick creation
            document.getElementById('expiryInfo').textContent =
                '⚠️ Will be deleted after first view or in 24 hours';

            // Scroll to success message
            document.getElementById('successMessage').scrollIntoView({ behavior: 'smooth' });

            // Clean up URL
            window.history.replaceState({}, document.title, '/create');
        }
    </script>
</body>

</html>