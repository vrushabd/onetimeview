<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-8327032298153859">

    <!-- SEO Meta Tags -->
    <title>View Secret - OneTimeView | Secure One-Time Message</title>
    <meta name="description"
        content="View a one-time secret message or file. This content will be permanently deleted after viewing.">
    <meta name="robots" content="noindex, nofollow">
    <link rel="canonical" href="https://onetimeview.app/view">

    <!-- Mobile & Theme -->
    <meta name="theme-color" content="#8B5CF6">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">

    <!-- Performance Optimization -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/tailwind-config.js"></script>
    <script src="/static/config.js"></script>
    <link rel="stylesheet" href="/static/styles.css">
    <!-- Vercel Analytics -->
    <script>
        window.va = window.va || function () { (window.va.q = window.va.q || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
    <!-- Vercel Speed Insights -->
    <script>
        window.si = window.si || function () { (window.si.q = window.si.q || []).push(arguments); };
    </script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
</head>

<body class="bg-background min-h-screen text-text-primary">
    <!-- Navigation -->
    <nav class="container mx-auto px-6 py-4 border-b border-card-border">
        <div class="flex justify-between items-center">
            <a href="/" class="flex items-center gap-2 group">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"
                    class="transition-transform group-hover:scale-110">
                    <path d="M16 8C10 8 5 12 3 16C5 20 10 24 16 24C22 24 27 20 29 16C27 12 22 8 16 8Z" stroke="#6D5DF6"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                    <circle cx="16" cy="16" r="5" fill="#6D5DF6" />
                    <text x="16" y="20" font-family="Arial, sans-serif" font-size="8" font-weight="bold" fill="white"
                        text-anchor="middle">1</text>
                </svg>
                <span
                    class="text-xl font-semibold text-primary group-hover:text-white transition-colors">OneTimeView</span>
            </a>
        </div>
    </nav>

    <div class="container mx-auto px-4 sm:px-6 py-10">
        <div class="max-w-4xl mx-auto">
            <!-- Password Form -->
            <div id="passwordForm"
                class="hidden bg-card rounded-2xl p-6 sm:p-8 mb-6 border border-card-border shadow-soft">
                <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    <span>Password Required</span>
                </h3>
                <p class="text-text-secondary mb-4">This secret is password protected. Enter the password to continue.
                </p>
                <div class="flex items-center space-x-3">
                    <input type="password" id="passwordInput"
                        class="flex-1 bg-background border border-card-border rounded-lg px-4 py-3 text-text-primary focus:border-primary focus:outline-none"
                        placeholder="Enter password">
                    <button onclick="verifyPassword()"
                        class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-bold transition">
                        Verify
                    </button>
                </div>
                <p id="passwordError" class="text-red-400 text-sm mt-2 hidden">Incorrect password. Please try again.</p>
            </div>

            <!-- Content Display -->
            <div id="contentDisplay"
                class="hidden bg-card rounded-2xl p-6 sm:p-8 border border-card-border shadow-soft space-y-6">
                <div class="text-center">
                    <p class="text-sm uppercase tracking-[0.2em] text-primary mb-2">Secret Viewer</p>
                    <h2 class="text-2xl font-bold text-white" id="viewerTitle">Your secret</h2>
                </div>
                <!-- Text Content -->
                <div id="textContent" class="hidden">
                    <div class="bg-black/50 rounded-lg p-6 whitespace-pre-wrap break-words text-gray-200 mb-4"
                        id="textBody">
                    </div>
                    <button onclick="copyToClipboard()"
                        class="bg-cta hover:bg-cta-hover text-white font-bold py-3 px-6 rounded-lg transition flex items-center gap-2 copy-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        <span id="copyButtonText">Copy to clipboard</span>
                    </button>
                    <p class="text-text-secondary text-sm mt-4 text-center">You can close this window when done.</p>
                </div>

                <!-- Image Content -->
                <div id="imageContent" class="hidden">
                    <div class="bg-black/80 rounded-xl p-3 sm:p-4 mb-4">
                        <img id="imageBody" class="w-full h-auto rounded-lg shadow-2xl no-select"
                            style="max-height: 80vh; object-fit: contain;" draggable="false"
                            oncontextmenu="return false;">
                    </div>
                </div>

                <!-- Video Content -->
                <div id="videoContent" class="hidden">
                    <div class="bg-black/80 rounded-xl p-3 sm:p-4 mb-4">
                        <video id="videoBody" controls controlsList="nodownload noremoteplayback"
                            class="w-full h-auto rounded-lg shadow-2xl no-select" style="max-height: 80vh;"
                            oncontextmenu="return false;" disablePictureInPicture>
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>

                <!-- File Content -->
                <div id="fileContent" class="hidden text-center space-y-3">
                    <div class="flex justify-center">
                        <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary">
                            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                            <polyline points="13 2 13 9 20 9"></polyline>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-text-secondary">Secret File Ready</h3>
                    <p class="text-text-secondary" id="fileInfo"></p>
                    <a id="downloadBtn" href="#" download
                        class="inline-block bg-cta hover:bg-cta-hover text-white font-bold py-3 px-6 rounded-lg transition">
                        ðŸ“¥ Download File
                    </a>
                </div>

                <div class="mt-8 text-center">
                    <a href="/create" class="text-text-secondary hover:text-text-primary underline">Create your own
                        secret
                        â†’</a>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-primary">
                </div>
                <p class="mt-4 text-text-secondary">Loading secret...</p>
            </div>
        </div>
    </div>

    <!-- Remaining Views Counter -->
    <div id="viewsCounter"
        class="fixed top-24 right-6 bg-card border border-card-border px-4 py-2 rounded-lg shadow-lg hidden">
        <span class="text-text-secondary">Remaining views - </span>
        <span id="viewsCountValue" class="font-bold text-primary-light"></span>
    </div>

    <style>
        /* Disable text selection and drag for security */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
    </style>

    <script>
        // ========================================
        // SECURITY: DevTools & Download Protection
        // ========================================

        (function () {
            'use strict';

            // 1. Disable right-click context menu
            document.addEventListener('contextmenu', function (e) {
                e.preventDefault();
                return false;
            });

            // 2. Disable keyboard shortcuts
            document.addEventListener('keydown', function (e) {
                // F12 - DevTools
                if (e.keyCode === 123) {
                    e.preventDefault();
                    return false;
                }

                // Ctrl+Shift+I or Cmd+Option+I - Inspector
                if ((e.ctrlKey && e.shiftKey && e.keyCode === 73) ||
                    (e.metaKey && e.altKey && e.keyCode === 73)) {
                    e.preventDefault();
                    return false;
                }

                // Ctrl+Shift+J or Cmd+Option+J - Console
                if ((e.ctrlKey && e.shiftKey && e.keyCode === 74) ||
                    (e.metaKey && e.altKey && e.keyCode === 74)) {
                    e.preventDefault();
                    return false;
                }

                // Ctrl+U or Cmd+Option+U - View Source
                if ((e.ctrlKey && e.keyCode === 85) ||
                    (e.metaKey && e.altKey && e.keyCode === 85)) {
                    e.preventDefault();
                    return false;
                }

                // Ctrl+S or Cmd+S - Save Page
                if ((e.ctrlKey && e.keyCode === 83) ||
                    (e.metaKey && e.keyCode === 83)) {
                    e.preventDefault();
                    return false;
                }

                // Ctrl+Shift+C or Cmd+Option+C - Inspect Element
                if ((e.ctrlKey && e.shiftKey && e.keyCode === 67) ||
                    (e.metaKey && e.altKey && e.keyCode === 67)) {
                    e.preventDefault();
                    return false;
                }
            });

            // 3. DevTools detection
            let devtoolsOpen = false;
            const threshold = 160;

            const detectDevTools = () => {
                const widthThreshold = window.outerWidth - window.innerWidth > threshold;
                const heightThreshold = window.outerHeight - window.innerHeight > threshold;

                if (widthThreshold || heightThreshold) {
                    if (!devtoolsOpen) {
                        devtoolsOpen = true;
                        handleDevToolsOpen();
                    }
                } else {
                    devtoolsOpen = false;
                }
            };

            const handleDevToolsOpen = () => {
                // Redirect to home or show warning
                alert('âš ï¸ Developer tools are disabled for security reasons.');
                window.location.href = '/';
            };

            // Check for DevTools using debugger
            setInterval(() => {
                const start = performance.now();
                debugger;
                const end = performance.now();

                if (end - start > 100) {
                    handleDevToolsOpen();
                }
            }, 1000);

            // Check window size changes
            window.addEventListener('resize', detectDevTools);
            setInterval(detectDevTools, 500);

            // 4. Disable drag events on images and videos
            document.addEventListener('dragstart', function (e) {
                if (e.target.tagName === 'IMG' || e.target.tagName === 'VIDEO') {
                    e.preventDefault();
                    return false;
                }
            });

            // 5. Clear console regularly to prevent URL inspection
            setInterval(() => {
                if (console.clear) {
                    console.clear();
                }
            }, 2000);

            // 6. Disable text selection on sensitive elements
            document.addEventListener('selectstart', function (e) {
                if (e.target.tagName === 'IMG' ||
                    e.target.tagName === 'VIDEO' ||
                    e.target.className.includes('no-select')) {
                    e.preventDefault();
                    return false;
                }
            });

            // 7. Override console methods to prevent inspection
            const noop = () => { };
            ['log', 'debug', 'info', 'warn', 'error'].forEach(method => {
                console[method] = noop;
            });

        })();
    </script>

    <script>
        const secretId = window.location.pathname.split('/').pop();
        let passwordVerified = false;
        let currentPassword = null;
        let mediaLoading = false;

        // Helpers
        function addPasswordParam(url, password) {
            if (!password) return url;
            try {
                const parsed = new URL(url);
                parsed.searchParams.set('password', password);
                return parsed.toString();
            } catch (e) {
                return url;
            }
        }

        function showLoading() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.classList.remove('hidden');
        }

        function hideLoading() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner && !mediaLoading) {
                spinner.classList.add('hidden');
            }
        }

        // Auto-load secret on page load
        async function init() {
            try {
                // Check if password is required
                const response = await fetch(`${API_BASE_URL}/api/secrets/${secretId}/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: '' })
                });

                if (response.status === 404) {
                    const error = await response.json().catch(() => ({}));
                    const reason = encodeURIComponent(error.detail || 'unknown');
                    window.location.href = `/expired?reason=${reason}`;
                    return;
                }

                if (!response.ok) {
                    console.error('Verify failed:', response.status);
                    window.location.href = '/expired?reason=Verification failed';
                    return;
                }

                const data = await response.json();
                if (data.verified === true) {
                    // If this is the last remaining view, confirm before consuming it
                    if (data.remaining_views === 1) {
                        const confirmLast = confirm('This is the last time this secret can be viewed. After this, it will be permanently deleted. Continue?');
                        if (!confirmLast) {
                            window.location.href = '/';
                            return;
                        }
                    }
                    // No password required - auto-load content
                    viewSecret();
                } else {
                    // Password is required - show password form
                    hideLoading();
                    document.getElementById('passwordForm').classList.remove('hidden');
                }

            } catch (error) {
                console.error('Error checking password:', error);
                window.location.href = '/expired';
            }
        }

        async function verifyPassword() {
            const password = document.getElementById('passwordInput').value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/secrets/${secretId}/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (data.verified) {
                    // If this is the last remaining view, confirm before consuming it
                    if (data.remaining_views === 1) {
                        const confirmLast = confirm('This is the last time this secret can be viewed. After this, it will be permanently deleted. Continue?');
                        if (!confirmLast) {
                            return;
                        }
                    }
                    passwordVerified = true;
                    currentPassword = password;
                    document.getElementById('passwordForm').classList.add('hidden');
                    document.getElementById('passwordError').classList.add('hidden');
                    showLoading();
                    viewSecret();
                } else {
                    document.getElementById('passwordError').classList.remove('hidden');
                }

            } catch (error) {
                alert('Error verifying password: ' + error.message);
            }
        }

        async function viewSecret() {
            try {
                // For text secrets, we use the /api/secrets endpoint
                // For file-based secrets (image/video/file), we directly use the file endpoints

                // First, check the content type by making a metadata request
                const verifyUrl = `${API_BASE_URL}/api/secrets/${secretId}/verify`;
                const verifyResponse = await fetch(verifyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: currentPassword || '' })
                });

                if (!verifyResponse.ok) {
                    if (verifyResponse.status === 404) {
                        const error = await verifyResponse.json().catch(() => ({}));
                        const reason = encodeURIComponent(error.detail || 'unknown');
                        window.location.href = `/expired?reason=${reason}`;
                        return;
                    }
                    window.location.href = '/expired?reason=Verification failed';
                    return;
                }

                // Now get the secret metadata to know the content type
                const metadataUrl = currentPassword
                    ? `${API_BASE_URL}/api/secrets/${secretId}?password=${encodeURIComponent(currentPassword)}`
                    : `${API_BASE_URL}/api/secrets/${secretId}`;

                const response = await fetch(metadataUrl);

                if (!response.ok) {
                    if (response.status === 404) {
                        const error = await response.json().catch(() => ({}));
                        const reason = encodeURIComponent(error.detail || 'unknown');
                        window.location.href = `/expired?reason=${reason}`;
                        return;
                    }
                    throw new Error('Failed to load secret');
                }

                const data = await response.json();

                // Show main container (we may still keep spinner for slow media)
                document.getElementById('contentDisplay').classList.remove('hidden');

                // Display remaining views in corner
                const viewsCounter = document.getElementById('viewsCounter');
                const viewsCountValue = document.getElementById('viewsCountValue');

                if (data.remaining_views > 0) {
                    viewsCounter.classList.remove('hidden');
                    viewsCountValue.textContent = `${data.remaining_views}`;
                }

                // Display based on content type
                if (data.content_type === 'text') {
                    // Text content is returned directly in the metadata response
                    document.getElementById('textContent').classList.remove('hidden');
                    document.getElementById('textBody').textContent = data.content;
                    mediaLoading = false;
                    hideLoading();
                } else if (data.content_type === 'image') {
                    // For images, use the download_url from response (Cloudinary URL)
                    mediaLoading = true;
                    showLoading();
                    document.getElementById('imageContent').classList.remove('hidden');
                    if (data.download_url) {
                        document.getElementById('imageBody').src = addPasswordParam(data.download_url, currentPassword);
                    } else {
                        // Fallback to API endpoint if no download_url
                        const imageUrl = currentPassword
                            ? `${API_BASE_URL}/api/image/${secretId}?password=${encodeURIComponent(currentPassword)}`
                            : `${API_BASE_URL}/api/image/${secretId}`;
                        document.getElementById('imageBody').src = imageUrl;
                    }
                } else if (data.content_type === 'video') {
                    // For videos, use the download_url from response (Cloudinary URL)
                    mediaLoading = true;
                    showLoading();
                    document.getElementById('videoContent').classList.remove('hidden');
                    const videoElement = document.getElementById('videoBody');
                    if (data.download_url) {
                        videoElement.src = addPasswordParam(data.download_url, currentPassword);
                    } else {
                        // Fallback to API endpoint if no download_url
                        const videoUrl = currentPassword
                            ? `${API_BASE_URL}/api/video/${secretId}?password=${encodeURIComponent(currentPassword)}`
                            : `${API_BASE_URL}/api/video/${secretId}`;
                        videoElement.src = videoUrl;
                    }
                    // Force the video element to load the source
                    videoElement.load();
                } else if (data.content_type === 'file') {
                    // For files, use the download_url from response (Cloudinary URL)
                    document.getElementById('fileContent').classList.remove('hidden');
                    document.getElementById('fileInfo').textContent = `File: ${data.file_name}`;
                    if (data.download_url) {
                        document.getElementById('downloadBtn').href = addPasswordParam(data.download_url, currentPassword);
                    } else {
                        // Fallback to API endpoint if no download_url
                        const fileUrl = currentPassword
                            ? `${API_BASE_URL}/api/file/${secretId}?password=${encodeURIComponent(currentPassword)}`
                            : `${API_BASE_URL}/api/file/${secretId}`;
                        document.getElementById('downloadBtn').href = fileUrl;
                    }
                    document.getElementById('downloadBtn').download = data.file_name;
                    mediaLoading = false;
                    hideLoading();
                }

            } catch (error) {
                alert('Error loading secret: ' + error.message);
                window.location.href = '/expired';
            }
        }

        // Media load handlers to hide spinner when content is ready
        window.addEventListener('load', () => {
            const imageEl = document.getElementById('imageBody');
            const videoEl = document.getElementById('videoBody');

            if (imageEl) {
                imageEl.addEventListener('load', () => {
                    mediaLoading = false;
                    hideLoading();
                });
                imageEl.addEventListener('error', () => {
                    mediaLoading = false;
                    hideLoading();
                });
            }

            if (videoEl) {
                // loadeddata fires when enough data is available to start playback
                videoEl.addEventListener('loadeddata', () => {
                    mediaLoading = false;
                    hideLoading();
                });
                videoEl.addEventListener('error', () => {
                    mediaLoading = false;
                    hideLoading();
                });
            }

            // Auto-load on page load (after handlers are ready)
            init();
        });

        // Copy to clipboard function
        async function copyToClipboard() {
            const textBody = document.getElementById('textBody');
            const copyButtonText = document.getElementById('copyButtonText');

            try {
                await navigator.clipboard.writeText(textBody.textContent);

                // Visual feedback
                const originalText = copyButtonText.textContent;
                copyButtonText.textContent = 'Copied!';

                setTimeout(() => {
                    copyButtonText.textContent = originalText;
                }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                alert('Failed to copy to clipboard');
            }
        }

        // Allow Enter key to submit password
        document.getElementById('passwordInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                verifyPassword();
            }
        });
    </script>
</body>

</html>